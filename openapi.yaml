openapi: 3.1.0
info:
  title: Sistema de Turnos Ambulatorios API
  version: 1.0.0
  description: API para gestión de pacientes, profesionales y turnos médicos.
servers:
  - url: http://localhost:8000
security:
  - bearerAuth: []

tags:
  - name: Patients
  - name: Professionals
  - name: Appointments

paths:
  /patients:
    get:
      tags: [Patients]
      summary: Listar pacientes
      parameters:
        - in: query
          name: skip
          schema: { type: integer, minimum: 0 }
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, default: 100 }
      responses:
        '200':
          description: Lista de pacientes
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Patient' }
    post:
      tags: [Patients]
      summary: Crear paciente
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PatientCreate' }
      responses:
        '201':
          description: Paciente creado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Patient' }
  /patients/{patient_id}:
    get:
      tags: [Patients]
      summary: Obtener paciente por ID
      parameters:
        - in: path
          name: patient_id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Paciente
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Patient' }
        '404': { description: No encontrado }
    put:
      tags: [Patients]
      summary: Actualizar paciente
      parameters:
        - in: path
          name: patient_id
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PatientCreate' }
      responses:
        '200':
          description: Paciente actualizado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Patient' }
        '404': { description: No encontrado }
    delete:
      tags: [Patients]
      summary: Eliminar paciente
      parameters:
        - in: path
          name: patient_id
          required: true
          schema: { type: integer }
      responses:
        '204': { description: Eliminado }
        '404': { description: No encontrado }

  /professionals:
    get:
      tags: [Professionals]
      summary: Listar profesionales
      parameters:
        - in: query
          name: skip
          schema: { type: integer, minimum: 0 }
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, default: 100 }
      responses:
        '200':
          description: Lista de profesionales
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Professional' }
    post:
      tags: [Professionals]
      summary: Crear profesional
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ProfessionalCreate' }
      responses:
        '201':
          description: Profesional creado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Professional' }
  /professionals/{professional_id}:
    get:
      tags: [Professionals]
      summary: Obtener profesional por ID
      parameters:
        - in: path
          name: professional_id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Profesional
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Professional' }
        '404': { description: No encontrado }
    put:
      tags: [Professionals]
      summary: Actualizar profesional
      parameters:
        - in: path
          name: professional_id
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ProfessionalCreate' }
      responses:
        '200':
          description: Profesional actualizado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Professional' }
        '404': { description: No encontrado }
    delete:
      tags: [Professionals]
      summary: Eliminar profesional
      parameters:
        - in: path
          name: professional_id
          required: true
          schema: { type: integer }
      responses:
        '204': { description: Eliminado }
        '404': { description: No encontrado }

  /appointments:
    post:
      tags: [Appointments]
      summary: Crear turno
      description: Crea un turno y publica evento asincrónico para notificación.
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AppointmentCreate' }
      responses:
        '201':
          description: Turno creado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Appointment' }
        '400': { description: Error de validación }
  /appointments/{appointment_id}:
    get:
      tags: [Appointments]
      summary: Obtener turno por ID
      parameters:
        - in: path
          name: appointment_id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Turno
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Appointment' }
        '404': { description: No encontrado }
  /appointments/professional/{professional_id}:
    get:
      tags: [Appointments]
      summary: Agenda de un profesional
      parameters:
        - in: path
          name: professional_id
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Lista de turnos
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Appointment' }
  /appointments/me/agenda:
    get:
      tags: [Appointments]
      summary: Agenda del profesional autenticado
      responses:
        '200':
          description: Lista de turnos
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Appointment' }
  /appointments/{appointment_id}/status:
    patch:
      tags: [Appointments]
      summary: Actualizar estado del turno
      parameters:
        - in: path
          name: appointment_id
          required: true
          schema: { type: integer }
        - in: query
          name: status
          required: true
          schema: { $ref: '#/components/schemas/AppointmentStatus' }
        - in: query
          name: webhook_url
          required: false
          schema: { type: string, format: uri }
      responses:
        '200':
          description: Turno actualizado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Appointment' }
        '404': { description: No encontrado }

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    AppointmentStatus:
      type: string
      enum: [PENDING, CONFIRMED, CANCELLED, COMPLETED]
    Patient:
      type: object
      required: [id, first_name, last_name, email, created_at]
      properties:
        id: { type: integer }
        first_name: { type: string }
        last_name: { type: string }
        email: { type: string, format: email }
        phone: { type: string, nullable: true }
        created_at: { type: string, format: date-time }
    PatientCreate:
      type: object
      required: [first_name, last_name, email]
      properties:
        first_name: { type: string }
        last_name: { type: string }
        email: { type: string, format: email }
        phone: { type: string, nullable: true }
    Professional:
      type: object
      required: [id, first_name, last_name, email, created_at]
      properties:
        id: { type: integer }
        first_name: { type: string }
        last_name: { type: string }
        email: { type: string, format: email }
        specialty: { type: string, nullable: true }
        is_active: { type: boolean }
        created_at: { type: string, format: date-time }
    ProfessionalCreate:
      type: object
      required: [first_name, last_name, email]
      properties:
        first_name: { type: string }
        last_name: { type: string }
        email: { type: string, format: email }
        specialty: { type: string, nullable: true }
    Appointment:
      type: object
      required: [id, patient_id, professional_id, start_time, end_time, status, created_at]
      properties:
        id: { type: integer }
        patient_id: { type: integer }
        professional_id: { type: integer }
        start_time: { type: string, format: date-time }
        end_time: { type: string, format: date-time }
        notes: { type: string, nullable: true }
        status: { $ref: '#/components/schemas/AppointmentStatus' }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time, nullable: true }
    AppointmentCreate:
      type: object
      required: [professional_id, start_time, end_time]
      properties:
        professional_id: { type: integer }
        patient_id: { type: integer, nullable: true }
        start_time: { type: string, format: date-time }
        end_time: { type: string, format: date-time }
        notes: { type: string, nullable: true }
    Error:
      type: object
      required: [message]
      properties:
        message: { type: string }
        detail: { type: string, nullable: true }
